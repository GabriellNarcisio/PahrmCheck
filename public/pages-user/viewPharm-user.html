<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Farmácias da Região</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    .btn-custom { width: 100%; border-radius: 10px; padding: 12px; }
    #map { width: 100%; max-width: 400px; height: 400px; border-radius: 10px; border: 2px solid #dee2e6; margin-bottom: 1.5rem; }
  </style>
</head>
<body class="bg-white">
  <div class="container py-4" style="max-width: 500px;">
    <h4 class="text-center mb-4">Farmácias da região</h4>
    <div class="input-group mb-3">
      <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
      <input type="text" id="inputNomeFarmacia" class="form-control" placeholder="Digite o nome da farmácia..." />
    </div>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <select id="selectFiltro" class="form-select w-50">
        <option value="proximas" selected>Mais próximas</option>
        <option value="abertas">Aberta agora</option>
      </select>
      <span class="text-muted" id="contadorResultados">0 resultado(s)</span>
    </div>
    <div id="map"></div>
    <div class="d-grid gap-2 mb-4">
      <button class="btn btn-dark btn-custom" id="btn-route">TRAÇAR ROTA</button>
      <button class="btn btn-light border btn-custom" onclick="window.history.back()">CANCELAR</button>
    </div>
  </div>

  <script>
    let map;
    let userRealLocation = null;
    let routeLayer = null;
    let markersLayer = null; 
    let selectedPharmacy = null;
    let selectedMarker = null;

    const greenIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });
    const redIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });

    function initMap() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          userRealLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
          map = L.map('map').setView([userRealLocation.lat, userRealLocation.lng], 15);
          markersLayer = L.layerGroup().addTo(map);

          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
             attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(map);

          L.marker([userRealLocation.lat, userRealLocation.lng]).addTo(map).bindPopup('<b>Sua localização</b>').openPopup();
          buscarEExibirFarmacias();
        }, () => alert("Não foi possível obter sua localização. Por favor, permita o acesso."));
      } else {
        alert("Seu navegador não suporta geolocalização.");
      }
    }
    
    // ✅ FUNÇÃO ATUALIZADA: Removemos a distância em linha reta inicial
    function buscarEExibirFarmacias() {
      if (!userRealLocation) return;
      if (routeLayer) map.removeLayer(routeLayer); // Limpa a rota antiga se houver uma nova busca
      markersLayer.clearLayers();
      selectedPharmacy = null;
      selectedMarker = null;

      const nome = document.getElementById('inputNomeFarmacia').value;
      const filtro = document.getElementById('selectFiltro').value;
      
      const url = `/farmacias-proximas?name=${nome}&filtro=${filtro}`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          document.getElementById("contadorResultados").textContent = `${data.length} resultado(s)`;
          
          data.forEach(farmacia => {
            const icon = farmacia.status === 'aberta' ? greenIcon : redIcon;

            // O popup agora só tem o nome e o status
            const popupContent = `<b>${farmacia.nome}</b><br>
                                  ${farmacia.status === 'aberta' ? 'Status: Aberta' : 'Status: Fechada'}`;
            
            const marker = L.marker([farmacia.lat, farmacia.lng], { icon: icon })
              .bindPopup(popupContent)
              .addTo(markersLayer);

            marker.on('click', () => {
              selectedPharmacy = farmacia;
              selectedMarker = marker;
            });
          });
        });
    }
    
    // ✅ FUNÇÃO DE ROTA CORRIGIDA para não desenhar a rota em caso de erro
    function calculateAndDisplayRoute() {
      if(routeLayer) {
        map.removeLayer(routeLayer);
      }
      if (!selectedMarker || !selectedPharmacy) {
        alert("Ocorreu um erro: nenhuma farmácia selecionada.");
        return;
      }
      
      fetch('/trace-route', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ start: userRealLocation, end: selectedPharmacy })
      })
      .then(res => {
        if (!res.ok) {
           // Se a resposta do servidor não for OK, ele vai direto para o .catch
           return res.json().then(errData => { throw new Error(errData.error || 'Erro no servidor'); });
        }
        return res.json();
      })
      .then(data => {
        if (!data.coordinates || !data.summary) {
          throw new Error('A resposta do servidor não contém os dados completos da rota.');
        }

        // A rota só é desenhada AQUI, dentro do bloco de sucesso
        routeLayer = L.polyline(data.coordinates, { color: 'blue' }).addTo(map);
        map.fitBounds(routeLayer.getBounds());
        
        const drivingDistanceInKm = (data.summary.distance / 1000).toFixed(2);
        
        const finalPopupContent = `<b>${selectedPharmacy.nome}</b><br>
                                 ${selectedPharmacy.status === 'aberta' ? 'Status: Aberta' : 'Status: Fechada'}<br>
                                 <b>Distância (rota): ${drivingDistanceInKm} km</b>`;
                                 
        selectedMarker.bindPopup(finalPopupContent).openPopup();
      })
      .catch(err => {
        console.error("Erro ao traçar rota:", err);
        alert(`Não foi possível traçar a rota. Motivo: ${err.message}`);
      });
    }
    
    document.getElementById('inputNomeFarmacia').addEventListener('keyup', buscarEExibirFarmacias);
    document.getElementById('selectFiltro').addEventListener('change', buscarEExibirFarmacias);

    document.getElementById('btn-route').addEventListener('click', () => {
      if (userRealLocation && selectedPharmacy) {
        calculateAndDisplayRoute();
      } else {
        alert("Por favor, clique em uma farmácia no mapa para selecioná-la.");
      }
    });

    initMap();
  </script>
</body>
</html>